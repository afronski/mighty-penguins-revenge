<!DOCTYPE html>
<html>
  <head>
    <script src="/libraries/jaws.min.js"></script>

    <script src="/src/World.js"></script>
    <script src="/src/Player.js"></script>
    <script src="/src/Game.js"></script>
    <script src="/src/EntryPoint.js"></script>

    <link type="text/css" rel="stylesheet" href="/stylesheets/main.css" />

    <title>Mighty Penguins Revenge!</title>
  </head>

  <body class="body-sizing">
    <canvas width="900" height="450" class="canvas-sizing"></canvas>

    <script>
      function Example() {
        var player
        var blocks
        var fps
        var viewport
        var tile_map

        /* Called once when a game state is activated. Use it for one-time setup code. */
        this.setup = function() {
          blocks = new jaws.SpriteList()
          var world = new jaws.Rect(0, 0, 320*10, 320*2)

          for(var x = 0; x < world.width; x += 32 ) {
            blocks.push( new Sprite({image: "block.bmp", x: x, y: world.height - 32}) )
          }

          // A tile map, each cell is 32x32 pixels. There's 100 such cells across and 100 downwards.
          // Fit all items in array blocks into correct cells in the tilemap
          // Later on we can look them up really fast (see player.move)
          tile_map = new jaws.TileMap({size: [100,100], cell_size: [32,32]})
          tile_map.push(blocks)

          viewport = new jaws.Viewport({max_x: world.width, max_y: world.height})

          player = new Player();

          player.move = function() {
            this.x += this.vx
            if(tile_map.atRect(player.rect()).length > 0) {
              this.x -= this.vx
            }
            this.vx = 0

            this.y += this.vy
            var block = tile_map.atRect(player.rect())[0]
            if(block) {
              // Heading downwards
              if(this.vy > 0) {
                this.can_jump = true
                this.y = block.rect().y - 1
              }
              // Heading upwards (jumping)
              else if(this.vy <= 0) {
                this.setTop( block.rect().bottom )
              }
              this.vy = 0
            }
          }
        }

        /* update() will get called each game tick with your specified FPS. Put game logic here. */
        this.update = function() {

          if(jaws.pressed("left"))  { player.left() }
          if(jaws.pressed("right")) { player.right() }
          if(jaws.pressed("up"))    { if (player.can_jump) player.jump() }

          // some gravity
          player.vy += 0.4

          // apply vx / vy (x velocity / y velocity), check for collision detection in the process.
          player.update();
          player.move()


          // Tries to center viewport around player.x / player.y.
          // It won't go outside of 0 or outside of our previously specified max_x, max_y values.
          viewport.centerAround(player)

          this.player = player
        }

        /* Directly after each update draw() will be called. Put all your on-screen operations here. */
        this.draw = function() {
          jaws.clear()

          // the viewport magic. wrap all draw()-calls inside viewport.apply and it will draw those relative to the viewport.
          viewport.apply( function() {
            blocks.draw()
            player.draw()
          });
        }
      }

      jaws.onload = function() {
        jaws.unpack()
        jaws.assets.setRoot("images/").add([ "Player.png", "block.bmp"])
        jaws.start(Example)  // Our convenience function jaws.start() will load assets, call setup and loop update/draw in 60 FPS
      }
    </script>
  </body>
</html>